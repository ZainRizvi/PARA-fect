"use strict";var $=Object.defineProperty;var se=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var ae=Object.prototype.hasOwnProperty;var ne=(i,s)=>{for(var e in s)$(i,e,{get:s[e],enumerable:!0})},ie=(i,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of re(s))!ae.call(i,r)&&r!==e&&$(i,r,{get:()=>s[r],enumerable:!(t=se(s,r))||t.enumerable});return i};var oe=i=>ie($({},"__esModule",{value:!0}),i);var pe={};ne(pe,{default:()=>D});module.exports=oe(pe);var u=require("obsidian");function Y(i,s){let e=Object.keys(s).map(t=>le(i,t,s[t]));return e.length===1?e[0]:function(){e.forEach(t=>t())}}function le(i,s,e){let t=i[s],r=i.hasOwnProperty(s),n=r?t:function(){return Object.getPrototypeOf(i)[s].apply(this,arguments)},a=e(n);return t&&Object.setPrototypeOf(a,t),Object.setPrototypeOf(l,a),i[s]=l,o;function l(...c){return a===n&&i[s]===l&&o(),a.apply(this,c)}function o(){i[s]===l&&(r?i[s]=n:delete i[s]),a!==n&&(a=n,Object.setPrototypeOf(l,t||Function))}}var h=require("obsidian");function W(i,s){let e=F(i),t=F(s);return!!(e===t||t.startsWith(e+"/")||e.startsWith(t+"/"))}function G(i){for(let s=0;s<i.length;s++)for(let e=s+1;e<i.length;e++)if(W(i[s],i[e])){let t=F(i[s]),r=F(i[e]);return`PARA folders cannot be nested: "${t}" and "${r}"`}return null}function F(i){return i.replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function ce(i){let s=F(i),e=s.lastIndexOf("/");return e===-1?"":s.substring(0,e)}function S(i,s){let e=F(i),t=F(s);return ce(e)===t}function k(i){let s=F(i),e=s.lastIndexOf("/");return e===-1?s:s.substring(e+1)}function R(i,s,e){let t=F(i),r=`${t}/${s}`;if(!e.has(r))return r;let a=new Date().toISOString().split("T")[0],l=`${t}/${s} (Archived ${a})`;if(!e.has(l))return l;let o=2;for(;;){let c=`${t}/${s} (Archived ${a}) (${o})`;if(!e.has(c))return c;if(o++,o>1e3)throw new Error("Too many archive collisions - please clean up your archive folder")}}var H={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"};function q(i,s,e){let r=["projectsPath","areasPath","resourcesPath","archivePath"].filter(n=>n!==s);for(let n of r){let a=e[n],l=H[n],o=H[s];if(i===a)return`${o} folder cannot be the same as ${l} folder`;if(W(i,a))return`${o} folder cannot be nested with ${l} folder`}return null}function X(i){let s=i.indexOf("{{name}}");return s===-1?i:i.substring(0,s)}function J(i,s){return s.mtime-i.mtime}async function O(i,s){let e=(0,h.normalizePath)(s);i.vault.getAbstractFileByPath(e)||await i.vault.createFolder(e)}function M(i){return{Project:`# {{name}}

A project is a series of tasks linked to a goal, with a deadline.

## Status
- [ ] In Progress

## Goals
-

## Tasks
-

## Notes
- `,Area:`# {{name}}

An area is a sphere of activity with a standard to maintain over time.

## Responsibilities
-

## Standards
-

## Notes
- `,Resource:`# {{name}}

A resource is a topic or tool you want to reference in the future.

## Overview
-

## Key Points
-

## Related Resources
- `}[i]||`# {{name}}
`}var V=class extends h.AbstractInputSuggest{constructor(s,e){super(s,e)}getSuggestions(s){let e=this.app.vault.getAllLoadedFiles().filter(r=>r instanceof h.TFolder);if(!s)return e;let t=s.toLowerCase();return e.filter(r=>r.path.toLowerCase().includes(t))}renderSuggestion(s,e){e.setText(s.path)}selectSuggestion(s){this.setValue(s.path),this.close()}},P={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive",focusAfterArchive:!0,confirmBeforeArchive:!1,projectFolderFormat:"YYYY-MM-DD {{name}}",projectTemplatePath:"",areaTemplatePath:"",resourceTemplatePath:"",projectSortOrder:"disabled"},K={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"},E="aparatus-invalid-input",B="aparatus-warning-input";function N(i,s,e,t){let r=s.inputEl;class n extends h.AbstractInputSuggest{constructor(c,g){super(c,g)}getSuggestions(c){let g=e.app.vault.getAllLoadedFiles().filter(w=>typeof w.name=="string"&&w.name.endsWith(".md"));if(!c)return g.slice(0,50);let f=c.toLowerCase();return g.filter(w=>w.path.toLowerCase().includes(f)).slice(0,20)}renderSuggestion(c,g){g.setText(c.path)}selectSuggestion(c){this.setValue(c.path),this.close()}}new n(e.app,r);let a=document.createElement("div");a.classList.add("aparatus-inline-message"),a.style.display="none",a.style.color="var(--text-muted)",i.settingEl.insertAdjacentElement("afterend",a);let l=o=>{if(!o.trim()){a.style.display="none";return}e.app.vault.getAbstractFileByPath(o)?a.style.display="none":(a.textContent=`Template file "${o}" does not exist (will use default template)`,a.style.display="block")};r.addEventListener("blur",async()=>{let o=s.getValue().trim();l(o),await t(o)}),setTimeout(()=>l(s.getValue()),0)}function j(i,s,e,t){let r=s.inputEl;new V(t.app,r);let n=document.createElement("div");n.classList.add("aparatus-inline-message"),n.style.display="none",i.settingEl.insertAdjacentElement("afterend",n);let a=l=>{t.app.vault.getAbstractFileByPath(l)?(r.classList.remove(B),n.style.display="none"):(r.classList.add(B),n.textContent=`Folder "${l}" does not exist (will be created automatically)`,n.style.display="block")};s.setPlaceholder(K[e]).setValue(t.settings[e]),setTimeout(()=>a(t.settings[e]),0),r.addEventListener("blur",async()=>{let o=s.getValue().trim().replace(/\/+$/,"")||K[e],c=q(o,e,t.settings);c?(r.classList.add(E),r.classList.remove(B),n.textContent=c,n.style.color="var(--text-error)",n.style.display="block",s.setValue(t.settings[e]),setTimeout(()=>{r.classList.remove(E),n.style.color="var(--color-yellow)",a(t.settings[e])},100)):(r.classList.remove(E),a(o),t.settings[e]=o,await t.saveSettings())})}var C=class extends h.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;s.empty();let e=new h.Setting(s).setName("Projects folder").setDesc("Path to your Projects folder (top-level project folders live here)");e.addText(p=>j(e,p,"projectsPath",this.plugin));let t=new h.Setting(s).setName("Areas folder").setDesc("Path to your Areas folder (top-level area folders live here)");t.addText(p=>j(t,p,"areasPath",this.plugin));let r=new h.Setting(s).setName("Resources folder").setDesc("Path to your Resources folder (top-level resource folders live here)");r.addText(p=>j(r,p,"resourcesPath",this.plugin));let n=new h.Setting(s).setName("Archive folder").setDesc("Path where archived items will be moved");n.addText(p=>j(n,p,"archivePath",this.plugin));let a=new h.Setting(s).setName("Project folder format"),l=document.createDocumentFragment();l.appendText("Use {{name}} for project name. Supports ");let o=document.createElement("a");o.href="https://momentjs.com/docs/#/displaying/format/",o.textContent="Moment.js tokens",o.setAttr("target","_blank"),l.appendChild(o),l.appendText(": YYYY, MM, DD, etc."),a.setDesc(l);let c=document.createElement("div");c.classList.add("aparatus-inline-message"),c.style.color="var(--text-muted)",a.addText(p=>{let m=p.inputEl,v=d=>{let x=d.includes("{{name}}");if(x){let y="My Project",T=window.moment(),ee=d.replace(/\{\{name\}\}/g,`[${y}]`),te=T.format(ee);c.textContent=`Preview: ${te}`,c.style.color="var(--text-muted)",m.style.borderColor="",m.classList.remove(E)}else c.textContent="Format must contain {{name}}",c.style.color="var(--text-error)",m.classList.add(E);return x};p.setPlaceholder("YYYY-MM-DD {{name}}").setValue(this.plugin.settings.projectFolderFormat),v(this.plugin.settings.projectFolderFormat),m.addEventListener("input",()=>{let d=p.getValue().trim()||P.projectFolderFormat;v(d)}),m.addEventListener("blur",async()=>{let d=p.getValue().trim()||P.projectFolderFormat;v(d)?(this.plugin.settings.projectFolderFormat=d,await this.plugin.saveSettings()):(p.setValue(this.plugin.settings.projectFolderFormat),v(this.plugin.settings.projectFolderFormat))})}),a.settingEl.insertAdjacentElement("afterend",c),new h.Setting(s).setName("Focus source folder after archive").setDesc("Return focus to the source folder (Projects, Areas, or Resources) after archiving").addToggle(p=>p.setValue(this.plugin.settings.focusAfterArchive).onChange(async m=>{this.plugin.settings.focusAfterArchive=m,await this.plugin.saveSettings()})),new h.Setting(s).setName("Confirm before archiving").setDesc("Show a confirmation dialog before archiving a project").addToggle(p=>p.setValue(this.plugin.settings.confirmBeforeArchive).onChange(async m=>{this.plugin.settings.confirmBeforeArchive=m,await this.plugin.saveSettings()})),new h.Setting(s).setName("Project folder sort order").setDesc("How to sort projects in the Projects folder").addDropdown(p=>p.addOption("disabled","Alphabetical (Obsidian default)").addOption("lastModified","Last modified (newest first)").addOption("datePrefix","Date prefix (newer first)").setValue(this.plugin.settings.projectSortOrder).onChange(async m=>{this.plugin.settings.projectSortOrder=m,await this.plugin.saveSettings(),this.plugin.installSortingPatch();let v=this.plugin.app.workspace.getLeavesOfType("file-explorer")[0];v&&v.view.requestSort?.()})),s.createEl("h3",{text:"Templates"});let g=new h.Setting(s).setName("Project template").setDesc("Template file to apply when creating new projects (optional)");g.addText(p=>{N(g,p,this.plugin,async m=>{this.plugin.settings.projectTemplatePath=m,await this.plugin.saveSettings()}),p.setValue(this.plugin.settings.projectTemplatePath)}),g.addButton(p=>p.setButtonText("Generate Default").onClick(async()=>{let m=M("Project"),v="Templates";await O(this.plugin.app,v);let d=`${v}/Project.md`;if(this.plugin.app.vault.getAbstractFileByPath(d)){new h.Notice("Template already exists at "+d);return}try{await this.plugin.app.vault.create(d,m),this.plugin.settings.projectTemplatePath=d,await this.plugin.saveSettings(),this.display(),new h.Notice("Created project template at "+d)}catch(y){let T=y instanceof Error?y.message:"Unknown error";new h.Notice("Failed to create template: "+T)}}));let f=new h.Setting(s).setName("Area template").setDesc("Template file to apply when creating new areas (optional)");f.addText(p=>{N(f,p,this.plugin,async m=>{this.plugin.settings.areaTemplatePath=m,await this.plugin.saveSettings()}),p.setValue(this.plugin.settings.areaTemplatePath)}),f.addButton(p=>p.setButtonText("Generate Default").onClick(async()=>{let m=M("Area"),v="Templates";await O(this.plugin.app,v);let d=`${v}/Area.md`;if(this.plugin.app.vault.getAbstractFileByPath(d)){new h.Notice("Template already exists at "+d);return}try{await this.plugin.app.vault.create(d,m),this.plugin.settings.areaTemplatePath=d,await this.plugin.saveSettings(),this.display(),new h.Notice("Created area template at "+d)}catch(y){let T=y instanceof Error?y.message:"Unknown error";new h.Notice("Failed to create template: "+T)}}));let w=new h.Setting(s).setName("Resource template").setDesc("Template file to apply when creating new resources (optional)");w.addText(p=>{N(w,p,this.plugin,async m=>{this.plugin.settings.resourceTemplatePath=m,await this.plugin.saveSettings()}),p.setValue(this.plugin.settings.resourceTemplatePath)}),w.addButton(p=>p.setButtonText("Generate Default").onClick(async()=>{let m=M("Resource"),v="Templates";await O(this.plugin.app,v);let d=`${v}/Resource.md`;if(this.plugin.app.vault.getAbstractFileByPath(d)){new h.Notice("Template already exists at "+d);return}try{await this.plugin.app.vault.create(d,m),this.plugin.settings.resourceTemplatePath=d,await this.plugin.saveSettings(),this.display(),new h.Notice("Created resource template at "+d)}catch(y){let T=y instanceof Error?y.message:"Unknown error";new h.Notice("Failed to create template: "+T)}}))}};var _=require("obsidian"),L=class extends _.Modal{constructor(e,t,r,n,a){super(e);this.confirmed=!1;this.itemName=t,this.destPath=r,this.onConfirm=n,this.onCancel=a}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Archive Item?"}),e.createEl("p",{text:`Move "${this.itemName}" to:`}),e.createEl("p",{text:this.destPath});let t=e.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let n=t.createEl("button",{text:"Archive",cls:"mod-cta"});n.addEventListener("click",()=>{this.confirmed=!0,this.onConfirm(),this.close()}),n.focus(),this.keydownHandler=a=>{a.key==="Enter"&&!a.isComposing?(a.preventDefault(),this.confirmed=!0,this.onConfirm(),this.close()):a.key==="Escape"&&(a.preventDefault(),this.close())},e.addEventListener("keydown",this.keydownHandler)}onClose(){let{contentEl:e}=this;this.keydownHandler&&e.removeEventListener("keydown",this.keydownHandler),e.empty(),this.confirmed||this.onCancel()}},b=class extends _.Modal{constructor(s,e,t,r){super(s),this.title=e,this.placeholder=t,this.onSubmit=r}onOpen(){let{contentEl:s}=this;s.createEl("h2",{text:this.title});let e=s.createEl("input",{type:"text",placeholder:this.placeholder});e.style.width="100%",e.style.marginBottom="1em",e.focus();let t=s.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"Create",cls:"mod-cta"}).addEventListener("click",()=>{let a=e.value.trim();a&&(this.onSubmit(a),this.close())}),e.addEventListener("keydown",a=>{if(a.key==="Enter"&&!a.isComposing){a.preventDefault();let l=e.value.trim();l&&(this.onSubmit(l),this.close())}else a.key==="Escape"&&(a.preventDefault(),this.close())})}onClose(){let{contentEl:s}=this;s.empty()}};var A=require("obsidian");async function I(i,s){let e=(0,A.normalizePath)(s),t=i.vault.getAbstractFileByPath(e);if(t){if(!(t instanceof A.TFolder))throw new Error(`"${e}" exists but is not a folder`);return}let r=e.split("/").filter(Boolean);for(let n=1;n<=r.length;n++){let a=r.slice(0,n).join("/"),l=i.vault.getAbstractFileByPath(a);if(!l)await i.vault.createFolder(a);else if(!(l instanceof A.TFolder))throw new Error(`Cannot create folder "${e}": intermediate path "${a}" exists but is not a folder`)}}function z(i,s){let e=new Set,t=i.vault.getAbstractFileByPath(s);if(t instanceof A.TFolder)for(let r of t.children)e.add((0,A.normalizePath)(r.path));return e}async function Q(i,s){let e=(0,A.normalizePath)(s),t=i.vault.getAbstractFileByPath(e);if(t)try{let r=i.workspace.getLeavesOfType("file-explorer")[0];if(!r)return;let n=r.view;typeof n.revealInFolder=="function"&&n.revealInFolder(t)}catch(r){console.debug("aPARAtus: Could not focus folder",r)}}function U(i){let s=0,e=t=>{for(let r of t.children)if(r instanceof A.TFolder)e(r);else{let n=r;typeof n.stat?.mtime=="number"&&(s=Math.max(s,n.stat.mtime))}};return e(i),s}var Z=3,D=class extends u.Plugin{constructor(){super(...arguments);this.settings=P;this.archivingItems=new Set;this.sortingPatchUninstaller=null;this.sortDebounceTimer=null}async onload(){await this.loadSettings(),this.app.workspace.onLayoutReady(()=>{this.installSortingPatch()}),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.installSortingPatch()})),this.registerEvent(this.app.vault.on("modify",e=>{if(this.settings.projectSortOrder==="lastModified"){let t=(0,u.normalizePath)(this.settings.projectsPath);e.path.startsWith(t+"/")&&(this.sortDebounceTimer&&clearTimeout(this.sortDebounceTimer),this.sortDebounceTimer=setTimeout(()=>{let r=this.app.workspace.getLeavesOfType("file-explorer")[0];r&&r.view.requestSort?.(),this.sortDebounceTimer=null},1e3))}})),this.addSettingTab(new C(this.app,this)),this.addCommand({id:"archive-item",name:"Archive Item",checkCallback:e=>{let t=this.app.workspace.getActiveFile();if(!t)return!1;let r=this.findTopLevelItem(t);return r?(e||this.archiveItem(r),!0):!1}}),this.addCommand({id:"create-project",name:"Create Project",callback:()=>{new b(this.app,"Create Project","Project name",e=>this.createParaItem(e,"projectsPath","Project")).open()}}),this.addCommand({id:"create-area",name:"Create Area",callback:()=>{new b(this.app,"Create Area","Area name",e=>this.createParaItem(e,"areasPath","Area")).open()}}),this.addCommand({id:"create-resource",name:"Create Resource",callback:()=>{new b(this.app,"Create Resource","Resource name",e=>this.createParaItem(e,"resourcesPath","Resource")).open()}}),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{!(t instanceof u.TFolder)&&!(t instanceof u.TFile)||!this.getSourceFolders().some(a=>S(t.path,a))||e.addItem(a=>{a.setTitle("Archive it").setIcon("archive").onClick(async()=>{await this.archiveItem(t)})})}))}onunload(){this.sortingPatchUninstaller?.(),this.archivingItems.clear(),this.sortDebounceTimer&&clearTimeout(this.sortDebounceTimer)}async loadSettings(){this.settings=Object.assign({},P,await this.loadData());let e=this.getSourceFolders(),t=(0,u.normalizePath)(this.settings.archivePath);if(e.includes(t)){new u.Notice("aPARAtus: Invalid settings detected (archive matches source folder), resetting to defaults"),this.settings.projectsPath=P.projectsPath,this.settings.areasPath=P.areasPath,this.settings.resourcesPath=P.resourcesPath,this.settings.archivePath=P.archivePath,await this.saveSettings();return}if(new Set(e).size!==e.length){new u.Notice("aPARAtus: Invalid settings detected (source folders match), resetting to defaults"),this.settings.projectsPath=P.projectsPath,this.settings.areasPath=P.areasPath,this.settings.resourcesPath=P.resourcesPath,await this.saveSettings();return}let n=[this.settings.projectsPath,this.settings.areasPath,this.settings.resourcesPath,this.settings.archivePath],a=G(n);a&&(new u.Notice(`aPARAtus: Invalid settings detected (${a}), resetting to defaults`),this.settings.projectsPath=P.projectsPath,this.settings.areasPath=P.areasPath,this.settings.resourcesPath=P.resourcesPath,this.settings.archivePath=P.archivePath,await this.saveSettings())}async saveSettings(){await this.saveData(this.settings)}isTemplaterAvailable(){try{return!!this.app.plugins?.plugins?.["templater-obsidian"]}catch{return!1}}isCoreTemplatesAvailable(){try{return!!this.app.internalPlugins?.plugins?.templates}catch{return!1}}async applyTemplate(e,t,r){if(!t.trim())return`# ${r}
`;let n=this.app.vault.getAbstractFileByPath(t);if(!(n instanceof u.TFile))return console.warn(`aPARAtus: Template file not found at ${t}, using default`),`# ${r}
`;try{if(this.isTemplaterAvailable()){let o=this.app.plugins?.plugins?.["templater-obsidian"]?.templater;if(o)return await o.parse_template({template_file:n,target_file:e})}return this.isCoreTemplatesAvailable()?(await this.app.vault.read(n)).replace(/{{name}}/g,r):(await this.app.vault.read(n)).replace(/{{name}}/g,r)}catch(a){let l=a instanceof Error?a.message:"Unknown error";return console.warn(`aPARAtus: Failed to apply template: ${l}, using default`),`# ${r}
`}}formatProjectName(e,t){let r=window.moment(),n=t.replace(/\{\{name\}\}/g,`[${e}]`);return r.format(n)}async createParaItem(e,t,r){let n=this.settings[t],a=e;t==="projectsPath"&&(a=this.formatProjectName(e,this.settings.projectFolderFormat));let l=(0,u.normalizePath)(`${n}/${a}`);if(this.app.vault.getAbstractFileByPath(l)){new u.Notice(`${r} "${e}" already exists`);return}try{await I(this.app,n),await this.app.vault.createFolder(l);let o=(0,u.normalizePath)(`${l}/index.md`),c="";t==="projectsPath"?c=this.settings.projectTemplatePath:t==="areasPath"?c=this.settings.areaTemplatePath:t==="resourcesPath"&&(c=this.settings.resourceTemplatePath);let g=await this.app.vault.create(o,""),f=await this.applyTemplate(g,c,e);f&&await this.app.vault.modify(g,f),await this.app.workspace.getLeaf().openFile(g),new u.Notice(`Created ${r.toLowerCase()} "${e}"`)}catch(o){let c=o instanceof Error?o.message:"Unknown error";new u.Notice(`Failed to create ${r.toLowerCase()}: ${c}`),console.error(`aPARAtus: Failed to create ${r}`,o)}}getSourceFolders(){return[(0,u.normalizePath)(this.settings.projectsPath),(0,u.normalizePath)(this.settings.areasPath),(0,u.normalizePath)(this.settings.resourcesPath)]}findTopLevelItem(e){let t=this.getSourceFolders();if(t.some(n=>S(e.path,n)))return e;let r=e.parent;for(;r;){if(t.some(n=>S(r.path,n)))return r;r=r.parent}return null}installSortingPatch(){if(this.sortingPatchUninstaller?.(),this.sortingPatchUninstaller=null,this.settings.projectSortOrder==="disabled")return;let e=this.app.workspace.getLeavesOfType("file-explorer")[0];if(!e){console.warn("aPARAtus: File explorer not found, cannot install sorting patch");return}let t=e.view;if(typeof t.getSortedFolderItems!="function"){console.warn("aPARAtus: getSortedFolderItems not found on file explorer view");return}if(typeof t.requestSort!="function"){console.warn("aPARAtus: requestSort not found on file explorer view");return}let r=(0,u.normalizePath)(this.settings.projectsPath),n=this;this.sortingPatchUninstaller=Y(t.constructor.prototype,{getSortedFolderItems(a){return function(l){if(l.path!==r)return a.call(this,l);try{let o=a.call(this,l);return n.sortProjectItems(o)}catch(o){return console.error("aPARAtus: Sorting failed, using default",o),a.call(this,l)}}}})}sortProjectItems(e){let t=[...e];if(this.settings.projectSortOrder==="lastModified")t.sort((r,n)=>{let a=r.file,l=n.file,o=a instanceof u.TFolder?U(a):a.stat?.mtime??0,c=l instanceof u.TFolder?U(l):l.stat?.mtime??0;return J({mtime:o},{mtime:c})});else if(this.settings.projectSortOrder==="datePrefix"){let r=X(this.settings.projectFolderFormat);t.sort((n,a)=>{let l=n.file,o=a.file,c=window.moment(l.name,r),g=window.moment(o.name,r),f=c.isValid(),w=g.isValid();return f&&w?g.valueOf()-c.valueOf():f&&!w?-1:!f&&w?1:0})}return t}async archiveItem(e){if(this.archivingItems.has(e.path))return;this.archivingItems.add(e.path);let t=(0,u.normalizePath)(this.settings.archivePath),r=k(e.path);try{let a=this.getSourceFolders().find(f=>S(e.path,f)),l=a?k(a):"";await I(this.app,t);let o=l?(0,u.normalizePath)(`${t}/${l}`):t;await I(this.app,o);let c=z(this.app,o),g=R(o,r,c);if(this.settings.confirmBeforeArchive)return new Promise(f=>{new L(this.app,r,g,async()=>{await this.performArchive(e,g,r,o,a),f()},()=>f()).open()});await this.performArchive(e,g,r,o,a)}catch(n){let a=n instanceof Error?n.message:"Unknown error";new u.Notice(`Failed to archive "${r}": ${a}`),console.error("aPARAtus: Failed to archive item",n)}finally{this.archivingItems.delete(e.path)}}async performArchive(e,t,r,n,a){let l=t;for(let o=0;o<Z;o++)try{await this.app.vault.rename(e,t);break}catch(c){if(o===Z-1)throw c;let g=z(this.app,n);g.add(t),t=R(n,r,g)}t!==l?new u.Notice(`Archived "${r}" to ${t} (path changed due to conflict)`):new u.Notice(`Archived "${r}" to ${t}`),this.settings.focusAfterArchive&&a&&await Q(this.app,a)}};
