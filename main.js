"use strict";var j=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var X=Object.prototype.hasOwnProperty;var q=(o,r)=>{for(var e in r)j(o,e,{get:r[e],enumerable:!0})},K=(o,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of G(r))!X.call(o,s)&&s!==e&&j(o,s,{get:()=>r[s],enumerable:!(t=W(r,s))||t.enumerable});return o};var J=o=>K(j({},"__esModule",{value:!0}),o);var Z={};q(Z,{default:()=>x});module.exports=J(Z);var h=require("obsidian");var g=require("obsidian");function N(o,r){let e=m(o),t=m(r);return!!(e===t||t.startsWith(e+"/")||e.startsWith(t+"/"))}function R(o){for(let r=0;r<o.length;r++)for(let e=r+1;e<o.length;e++)if(N(o[r],o[e])){let t=m(o[r]),s=m(o[e]);return`PARA folders cannot be nested: "${t}" and "${s}"`}return null}function m(o){return o.replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function Q(o){let r=m(o),e=r.lastIndexOf("/");return e===-1?"":r.substring(0,e)}function F(o,r){let e=m(o),t=m(r);return Q(e)===t}function T(o){let r=m(o),e=r.lastIndexOf("/");return e===-1?r:r.substring(e+1)}function C(o,r,e){let t=m(o),s=`${t}/${r}`;if(!e.has(s))return s;let a=new Date().toISOString().split("T")[0],c=`${t}/${r} (Archived ${a})`;if(!e.has(c))return c;let i=2;for(;;){let d=`${t}/${r} (Archived ${a}) (${i})`;if(!e.has(d))return d;if(i++,i>1e3)throw new Error("Too many archive collisions - please clean up your archive folder")}}var M={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"};function B(o,r,e){let s=["projectsPath","areasPath","resourcesPath","archivePath"].filter(n=>n!==r);for(let n of s){let a=e[n],c=M[n],i=M[r];if(o===a)return`${i} folder cannot be the same as ${c} folder`;if(N(o,a))return`${i} folder cannot be nested with ${c} folder`}return null}var I=class extends g.AbstractInputSuggest{constructor(r,e){super(r,e)}getSuggestions(r){let e=this.app.vault.getAllLoadedFiles().filter(s=>s instanceof g.TFolder);if(!r)return e;let t=r.toLowerCase();return e.filter(s=>s.path.toLowerCase().includes(t))}renderSuggestion(r,e){e.setText(r.path)}selectSuggestion(r){this.setValue(r.path),this.close()}},p={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive",focusAfterArchive:!0,confirmBeforeArchive:!1,projectFolderFormat:"YYYY-MM-DD {{name}}"},_={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"},A="para-manager-invalid-input",L="para-manager-warning-input";function y(o,r,e,t){let s=r.inputEl;new I(t.app,s);let n=document.createElement("div");n.classList.add("para-manager-inline-message"),n.style.display="none",o.settingEl.insertAdjacentElement("afterend",n);let a=c=>{t.app.vault.getAbstractFileByPath(c)?(s.classList.remove(L),n.style.display="none"):(s.classList.add(L),n.textContent=`Folder "${c}" does not exist (will be created automatically)`,n.style.display="block")};r.setPlaceholder(_[e]).setValue(t.settings[e]),setTimeout(()=>a(t.settings[e]),0),s.addEventListener("blur",async()=>{let i=r.getValue().trim().replace(/\/+$/,"")||_[e],d=B(i,e,t.settings);d?(s.classList.add(A),s.classList.remove(L),n.textContent=d,n.style.color="var(--text-error)",n.style.display="block",r.setValue(t.settings[e]),setTimeout(()=>{s.classList.remove(A),n.style.color="var(--color-yellow)",a(t.settings[e])},100)):(s.classList.remove(A),a(i),t.settings[e]=i,await t.saveSettings())})}var E=class extends g.PluginSettingTab{constructor(r,e){super(r,e),this.plugin=e}display(){let{containerEl:r}=this;r.empty();let e=new g.Setting(r).setName("Projects folder").setDesc("Path to your Projects folder (top-level project folders live here)");e.addText(l=>y(e,l,"projectsPath",this.plugin));let t=new g.Setting(r).setName("Areas folder").setDesc("Path to your Areas folder (top-level area folders live here)");t.addText(l=>y(t,l,"areasPath",this.plugin));let s=new g.Setting(r).setName("Resources folder").setDesc("Path to your Resources folder (top-level resource folders live here)");s.addText(l=>y(s,l,"resourcesPath",this.plugin));let n=new g.Setting(r).setName("Archive folder").setDesc("Path where archived items will be moved");n.addText(l=>y(n,l,"archivePath",this.plugin));let a=new g.Setting(r).setName("Project folder format"),c=document.createDocumentFragment();c.appendText("Use {{name}} for project name. Supports ");let i=document.createElement("a");i.href="https://momentjs.com/docs/#/displaying/format/",i.textContent="Moment.js tokens",i.setAttr("target","_blank"),c.appendChild(i),c.appendText(": YYYY, MM, DD, etc."),a.setDesc(c);let d=document.createElement("div");d.classList.add("para-manager-inline-message"),d.style.color="var(--text-muted)",a.addText(l=>{let u=l.inputEl,w=v=>{let k=v.includes("{{name}}");if(k){let V="My Project",Y=window.moment(),U=v.replace(/\{\{name\}\}/g,`[${V}]`),H=Y.format(U);d.textContent=`Preview: ${H}`,d.style.color="var(--text-muted)",u.style.borderColor="",u.classList.remove(A)}else d.textContent="Format must contain {{name}}",d.style.color="var(--text-error)",u.classList.add(A);return k};l.setPlaceholder("YYYY-MM-DD {{name}}").setValue(this.plugin.settings.projectFolderFormat),w(this.plugin.settings.projectFolderFormat),u.addEventListener("input",()=>{let v=l.getValue().trim()||p.projectFolderFormat;w(v)}),u.addEventListener("blur",async()=>{let v=l.getValue().trim()||p.projectFolderFormat;w(v)?(this.plugin.settings.projectFolderFormat=v,await this.plugin.saveSettings()):(l.setValue(this.plugin.settings.projectFolderFormat),w(this.plugin.settings.projectFolderFormat))})}),a.settingEl.insertAdjacentElement("afterend",d),new g.Setting(r).setName("Focus source folder after archive").setDesc("Return focus to the source folder (Projects, Areas, or Resources) after archiving").addToggle(l=>l.setValue(this.plugin.settings.focusAfterArchive).onChange(async u=>{this.plugin.settings.focusAfterArchive=u,await this.plugin.saveSettings()})),new g.Setting(r).setName("Confirm before archiving").setDesc("Show a confirmation dialog before archiving a project").addToggle(l=>l.setValue(this.plugin.settings.confirmBeforeArchive).onChange(async u=>{this.plugin.settings.confirmBeforeArchive=u,await this.plugin.saveSettings()}))}};var $=require("obsidian"),b=class extends $.Modal{constructor(e,t,s,n,a){super(e);this.confirmed=!1;this.itemName=t,this.destPath=s,this.onConfirm=n,this.onCancel=a}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Archive Item?"}),e.createEl("p",{text:`Move "${this.itemName}" to:`}),e.createEl("p",{text:this.destPath});let t=e.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let n=t.createEl("button",{text:"Archive",cls:"mod-cta"});n.addEventListener("click",()=>{this.confirmed=!0,this.onConfirm(),this.close()}),n.focus(),this.keydownHandler=a=>{a.key==="Enter"&&!a.isComposing?(a.preventDefault(),this.confirmed=!0,this.onConfirm(),this.close()):a.key==="Escape"&&(a.preventDefault(),this.close())},e.addEventListener("keydown",this.keydownHandler)}onClose(){let{contentEl:e}=this;this.keydownHandler&&e.removeEventListener("keydown",this.keydownHandler),e.empty(),this.confirmed||this.onCancel()}},P=class extends $.Modal{constructor(r,e,t,s){super(r),this.title=e,this.placeholder=t,this.onSubmit=s}onOpen(){let{contentEl:r}=this;r.createEl("h2",{text:this.title});let e=r.createEl("input",{type:"text",placeholder:this.placeholder});e.style.width="100%",e.style.marginBottom="1em",e.focus();let t=r.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"Create",cls:"mod-cta"}).addEventListener("click",()=>{let a=e.value.trim();a&&(this.onSubmit(a),this.close())}),e.addEventListener("keydown",a=>{if(a.key==="Enter"&&!a.isComposing){a.preventDefault();let c=e.value.trim();c&&(this.onSubmit(c),this.close())}else a.key==="Escape"&&(a.preventDefault(),this.close())})}onClose(){let{contentEl:r}=this;r.empty()}};var f=require("obsidian");async function S(o,r){let e=(0,f.normalizePath)(r),t=o.vault.getAbstractFileByPath(e);if(t){if(!(t instanceof f.TFolder))throw new Error(`"${e}" exists but is not a folder`);return}let s=e.split("/").filter(Boolean);for(let n=1;n<=s.length;n++){let a=s.slice(0,n).join("/"),c=o.vault.getAbstractFileByPath(a);if(!c)await o.vault.createFolder(a);else if(!(c instanceof f.TFolder))throw new Error(`Cannot create folder "${e}": intermediate path "${a}" exists but is not a folder`)}}function D(o,r){let e=new Set,t=o.vault.getAbstractFileByPath(r);if(t instanceof f.TFolder)for(let s of t.children)e.add((0,f.normalizePath)(s.path));return e}async function z(o,r){let e=(0,f.normalizePath)(r),t=o.vault.getAbstractFileByPath(e);if(t)try{let s=o.workspace.getLeavesOfType("file-explorer")[0];if(!s)return;let n=s.view;typeof n.revealInFolder=="function"&&n.revealInFolder(t)}catch(s){console.debug("PARA Manager: Could not focus folder",s)}}var O=3,x=class extends h.Plugin{constructor(){super(...arguments);this.settings=p;this.archivingItems=new Set}async onload(){await this.loadSettings(),this.addSettingTab(new E(this.app,this)),this.addCommand({id:"archive-item",name:"Archive Item",checkCallback:e=>{let t=this.app.workspace.getActiveFile();if(!t)return!1;let s=this.findTopLevelItem(t);return s?(e||this.archiveItem(s),!0):!1}}),this.addCommand({id:"create-project",name:"Create Project",callback:()=>{new P(this.app,"Create Project","Project name",e=>this.createParaItem(e,"projectsPath","Project")).open()}}),this.addCommand({id:"create-area",name:"Create Area",callback:()=>{new P(this.app,"Create Area","Area name",e=>this.createParaItem(e,"areasPath","Area")).open()}}),this.addCommand({id:"create-resource",name:"Create Resource",callback:()=>{new P(this.app,"Create Resource","Resource name",e=>this.createParaItem(e,"resourcesPath","Resource")).open()}}),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{!(t instanceof h.TFolder)&&!(t instanceof h.TFile)||!this.getSourceFolders().some(a=>F(t.path,a))||e.addItem(a=>{a.setTitle("Archive it").setIcon("archive").onClick(async()=>{await this.archiveItem(t)})})}))}onunload(){this.archivingItems.clear()}async loadSettings(){this.settings=Object.assign({},p,await this.loadData());let e=this.getSourceFolders(),t=(0,h.normalizePath)(this.settings.archivePath);if(e.includes(t)){new h.Notice("PARA Manager: Invalid settings detected (archive matches source folder), resetting to defaults"),this.settings.projectsPath=p.projectsPath,this.settings.areasPath=p.areasPath,this.settings.resourcesPath=p.resourcesPath,this.settings.archivePath=p.archivePath,await this.saveSettings();return}if(new Set(e).size!==e.length){new h.Notice("PARA Manager: Invalid settings detected (source folders match), resetting to defaults"),this.settings.projectsPath=p.projectsPath,this.settings.areasPath=p.areasPath,this.settings.resourcesPath=p.resourcesPath,await this.saveSettings();return}let n=[this.settings.projectsPath,this.settings.areasPath,this.settings.resourcesPath,this.settings.archivePath],a=R(n);a&&(new h.Notice(`PARA Manager: Invalid settings detected (${a}), resetting to defaults`),this.settings.projectsPath=p.projectsPath,this.settings.areasPath=p.areasPath,this.settings.resourcesPath=p.resourcesPath,this.settings.archivePath=p.archivePath,await this.saveSettings())}async saveSettings(){await this.saveData(this.settings)}formatProjectName(e,t){let s=window.moment(),n=t.replace(/\{\{name\}\}/g,`[${e}]`);return s.format(n)}async createParaItem(e,t,s){let n=this.settings[t],a=e;t==="projectsPath"&&(a=this.formatProjectName(e,this.settings.projectFolderFormat));let c=(0,h.normalizePath)(`${n}/${a}`);if(this.app.vault.getAbstractFileByPath(c)){new h.Notice(`${s} "${e}" already exists`);return}try{await S(this.app,n),await this.app.vault.createFolder(c);let i=(0,h.normalizePath)(`${c}/index.md`),d=`# ${e}
`,l=await this.app.vault.create(i,d);await this.app.workspace.getLeaf().openFile(l),new h.Notice(`Created ${s.toLowerCase()} "${e}"`)}catch(i){let d=i instanceof Error?i.message:"Unknown error";new h.Notice(`Failed to create ${s.toLowerCase()}: ${d}`),console.error(`PARA Manager: Failed to create ${s}`,i)}}getSourceFolders(){return[(0,h.normalizePath)(this.settings.projectsPath),(0,h.normalizePath)(this.settings.areasPath),(0,h.normalizePath)(this.settings.resourcesPath)]}findTopLevelItem(e){let t=this.getSourceFolders();if(t.some(n=>F(e.path,n)))return e;let s=e.parent;for(;s;){if(t.some(n=>F(s.path,n)))return s;s=s.parent}return null}async archiveItem(e){if(this.archivingItems.has(e.path))return;this.archivingItems.add(e.path);let t=(0,h.normalizePath)(this.settings.archivePath),s=T(e.path);try{let a=this.getSourceFolders().find(u=>F(e.path,u)),c=a?T(a):"";await S(this.app,t);let i=c?(0,h.normalizePath)(`${t}/${c}`):t;await S(this.app,i);let d=D(this.app,i),l=C(i,s,d);if(this.settings.confirmBeforeArchive)return new Promise(u=>{new b(this.app,s,l,async()=>{await this.performArchive(e,l,s,i,a),u()},()=>u()).open()});await this.performArchive(e,l,s,i,a)}catch(n){let a=n instanceof Error?n.message:"Unknown error";new h.Notice(`Failed to archive "${s}": ${a}`),console.error("PARA Manager: Failed to archive item",n)}finally{this.archivingItems.delete(e.path)}}async performArchive(e,t,s,n,a){let c=t;for(let i=0;i<O;i++)try{await this.app.vault.rename(e,t);break}catch(d){if(i===O-1)throw d;let l=D(this.app,n);l.add(t),t=C(n,s,l)}t!==c?new h.Notice(`Archived "${s}" to ${t} (path changed due to conflict)`):new h.Notice(`Archived "${s}" to ${t}`),this.settings.focusAfterArchive&&a&&await z(this.app,a)}};
