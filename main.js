"use strict";var y=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var z=(a,r)=>{for(var e in r)y(a,e,{get:r[e],enumerable:!0})},B=(a,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of M(r))!R.call(a,s)&&s!==e&&y(a,s,{get:()=>r[s],enumerable:!(t=k(r,s))||t.enumerable});return a};var O=a=>B(y({},"__esModule",{value:!0}),a);var H={};z(H,{default:()=>w});module.exports=O(H);var n=require("obsidian");var d=require("obsidian");function b(a,r){let e=u(a),t=u(r);return!!(e===t||t.startsWith(e+"/")||e.startsWith(t+"/"))}function C(a){for(let r=0;r<a.length;r++)for(let e=r+1;e<a.length;e++)if(b(a[r],a[e])){let t=u(a[r]),s=u(a[e]);return`PARA folders cannot be nested: "${t}" and "${s}"`}return null}function u(a){return a.replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function _(a){let r=u(a),e=r.lastIndexOf("/");return e===-1?"":r.substring(0,e)}function v(a,r){let e=u(a),t=u(r);return _(e)===t}function E(a){let r=u(a),e=r.lastIndexOf("/");return e===-1?r:r.substring(e+1)}function S(a,r,e){let t=u(a),s=`${t}/${r}`;if(!e.has(s))return s;let i=new Date().toISOString().split("T")[0],h=`${t}/${r} (Archived ${i})`;if(!e.has(h))return h;let c=2;for(;;){let f=`${t}/${r} (Archived ${i}) (${c})`;if(!e.has(f))return f;if(c++,c>1e3)throw new Error("Too many archive collisions - please clean up your archive folder")}}var l={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive",focusAfterArchive:!0,confirmBeforeArchive:!1},$={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"},j={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"};function V(a,r,e){let s=["projectsPath","areasPath","resourcesPath","archivePath"].filter(o=>o!==r);for(let o of s){let i=e[o],h=$[o],c=$[r];if(a===i)return`${c} folder cannot be the same as ${h} folder`;if(b(a,i))return`${c} folder cannot be nested with ${h} folder`}return null}var T="para-manager-invalid-input";function m(a,r,e){let t=a.inputEl;a.setPlaceholder(j[r]).setValue(e.settings[r]),t.addEventListener("blur",async()=>{let o=a.getValue().trim().replace(/\/+$/,"")||j[r],i=V(o,r,e.settings);i?(t.classList.add(T),t.style.borderColor="var(--text-error)",t.style.backgroundColor="rgba(var(--color-red-rgb), 0.1)",new d.Notice(i),a.setValue(e.settings[r]),setTimeout(()=>{t.classList.remove(T),t.style.borderColor="",t.style.backgroundColor=""},100)):(t.classList.remove(T),t.style.borderColor="",t.style.backgroundColor="",e.settings[r]=o,await e.saveSettings())})}var A=class extends d.PluginSettingTab{constructor(r,e){super(r,e),this.plugin=e}display(){let{containerEl:r}=this;r.empty(),new d.Setting(r).setName("Projects folder").setDesc("Path to your Projects folder (top-level project folders live here)").addText(e=>m(e,"projectsPath",this.plugin)),new d.Setting(r).setName("Areas folder").setDesc("Path to your Areas folder (top-level area folders live here)").addText(e=>m(e,"areasPath",this.plugin)),new d.Setting(r).setName("Resources folder").setDesc("Path to your Resources folder (top-level resource folders live here)").addText(e=>m(e,"resourcesPath",this.plugin)),new d.Setting(r).setName("Archive folder").setDesc("Path where archived items will be moved").addText(e=>m(e,"archivePath",this.plugin)),new d.Setting(r).setName("Focus source folder after archive").setDesc("Return focus to the source folder (Projects, Areas, or Resources) after archiving").addToggle(e=>e.setValue(this.plugin.settings.focusAfterArchive).onChange(async t=>{this.plugin.settings.focusAfterArchive=t,await this.plugin.saveSettings()})),new d.Setting(r).setName("Confirm before archiving").setDesc("Show a confirmation dialog before archiving a project").addToggle(e=>e.setValue(this.plugin.settings.confirmBeforeArchive).onChange(async t=>{this.plugin.settings.confirmBeforeArchive=t,await this.plugin.saveSettings()}))}};var L=require("obsidian"),F=class extends L.Modal{constructor(e,t,s,o,i){super(e);this.confirmed=!1;this.itemName=t,this.destPath=s,this.onConfirm=o,this.onCancel=i}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Archive Item?"}),e.createEl("p",{text:`Move "${this.itemName}" to:`}),e.createEl("p",{text:this.destPath,cls:"archive-dest-path"});let t=e.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let o=t.createEl("button",{text:"Archive",cls:"mod-cta"});o.addEventListener("click",()=>{this.confirmed=!0,this.onConfirm(),this.close()}),o.focus(),this.keydownHandler=i=>{i.key==="Enter"&&!i.isComposing?(i.preventDefault(),this.confirmed=!0,this.onConfirm(),this.close()):i.key==="Escape"&&(i.preventDefault(),this.close())},e.addEventListener("keydown",this.keydownHandler)}onClose(){let{contentEl:e}=this;this.keydownHandler&&e.removeEventListener("keydown",this.keydownHandler),e.empty(),this.confirmed||this.onCancel()}};var g=require("obsidian");async function x(a,r){let e=(0,g.normalizePath)(r),t=a.vault.getAbstractFileByPath(e);if(t){if(!(t instanceof g.TFolder))throw new Error(`"${e}" exists but is not a folder`);return}let s=e.split("/").filter(Boolean);for(let o=1;o<=s.length;o++){let i=s.slice(0,o).join("/"),h=a.vault.getAbstractFileByPath(i);if(!h)await a.vault.createFolder(i);else if(!(h instanceof g.TFolder))throw new Error(`Cannot create folder "${e}": intermediate path "${i}" exists but is not a folder`)}}function I(a,r){let e=new Set,t=a.vault.getAbstractFileByPath(r);if(t instanceof g.TFolder)for(let s of t.children)e.add((0,g.normalizePath)(s.path));return e}async function N(a,r){let e=(0,g.normalizePath)(r),t=a.vault.getAbstractFileByPath(e);if(t)try{let s=a.workspace.getLeavesOfType("file-explorer")[0];if(!s)return;let o=s.view;typeof o.revealInFolder=="function"&&o.revealInFolder(t)}catch(s){console.debug("PARA Manager: Could not focus folder",s)}}var D=3,w=class extends n.Plugin{constructor(){super(...arguments);this.settings=l;this.archivingItems=new Set}async onload(){await this.loadSettings(),this.addSettingTab(new A(this.app,this)),this.addCommand({id:"archive-item",name:"Archive Item",checkCallback:e=>{let t=this.app.workspace.getActiveFile();if(!t)return!1;let s=this.findTopLevelItem(t);return s?(e||this.archiveItem(s),!0):!1}}),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{!(t instanceof n.TFolder)&&!(t instanceof n.TFile)||!this.getSourceFolders().some(i=>v(t.path,i))||e.addItem(i=>{i.setTitle("Archive it").setIcon("archive").onClick(async()=>{await this.archiveItem(t)})})}))}async loadSettings(){this.settings=Object.assign({},l,await this.loadData());let e=this.getSourceFolders(),t=(0,n.normalizePath)(this.settings.archivePath);if(e.includes(t)){new n.Notice("PARA Manager: Invalid settings detected (archive matches source folder), resetting to defaults"),this.settings.projectsPath=l.projectsPath,this.settings.areasPath=l.areasPath,this.settings.resourcesPath=l.resourcesPath,this.settings.archivePath=l.archivePath,await this.saveSettings();return}if(new Set(e).size!==e.length){new n.Notice("PARA Manager: Invalid settings detected (source folders match), resetting to defaults"),this.settings.projectsPath=l.projectsPath,this.settings.areasPath=l.areasPath,this.settings.resourcesPath=l.resourcesPath,await this.saveSettings();return}let o=[this.settings.projectsPath,this.settings.areasPath,this.settings.resourcesPath,this.settings.archivePath],i=C(o);i&&(new n.Notice(`PARA Manager: Invalid settings detected (${i}), resetting to defaults`),this.settings.projectsPath=l.projectsPath,this.settings.areasPath=l.areasPath,this.settings.resourcesPath=l.resourcesPath,this.settings.archivePath=l.archivePath,await this.saveSettings())}async saveSettings(){await this.saveData(this.settings)}getSourceFolders(){return[(0,n.normalizePath)(this.settings.projectsPath),(0,n.normalizePath)(this.settings.areasPath),(0,n.normalizePath)(this.settings.resourcesPath)]}findTopLevelItem(e){let t=this.getSourceFolders();if(t.some(o=>v(e.path,o)))return e;let s=e.parent;for(;s;){if(t.some(o=>v(s.path,o)))return s;s=s.parent}return null}async archiveItem(e){if(this.archivingItems.has(e.path))return;this.archivingItems.add(e.path);let t=(0,n.normalizePath)(this.settings.archivePath),s=E(e.path);try{let i=this.getSourceFolders().find(P=>v(e.path,P)),h=i?E(i):"";await x(this.app,t);let c=h?(0,n.normalizePath)(`${t}/${h}`):t;await x(this.app,c);let f=I(this.app,c),p=S(c,s,f);if(this.settings.confirmBeforeArchive)return new Promise(P=>{new F(this.app,s,p,async()=>{await this.performArchive(e,p,s,c,i),P()},()=>P()).open()});await this.performArchive(e,p,s,c,i)}catch(o){let i=o instanceof Error?o.message:"Unknown error";new n.Notice(`Failed to archive "${s}": ${i}`),console.error("PARA Manager: Failed to archive item",o)}finally{this.archivingItems.delete(e.path)}}async performArchive(e,t,s,o,i){let h=t;for(let c=0;c<D;c++)try{await this.app.vault.rename(e,t);break}catch(f){if(c===D-1)throw f;let p=I(this.app,o);p.add(t),t=S(o,s,p)}t!==h?new n.Notice(`Archived "${s}" to ${t} (path changed due to conflict)`):new n.Notice(`Archived "${s}" to ${t}`),this.settings.focusAfterArchive&&i&&await N(this.app,i)}};
