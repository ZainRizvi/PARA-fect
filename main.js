"use strict";var u=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var T=(n,r)=>{for(var t in r)u(n,t,{get:r[t],enumerable:!0})},b=(n,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of y(r))!S.call(n,i)&&i!==t&&u(n,i,{get:()=>r[i],enumerable:!(e=E(r,i))||e.enumerable});return n};var x=n=>b(u({},"__esModule",{value:!0}),n);var $={};T($,{default:()=>f});module.exports=x($);var o=require("obsidian");var h=require("obsidian"),g={projectsPath:"Projects",archivePath:"Archive",focusAfterArchive:!0,confirmBeforeArchive:!1},v=class extends h.PluginSettingTab{constructor(r,t){super(r,t),this.plugin=t}display(){let{containerEl:r}=this;r.empty(),new h.Setting(r).setName("Projects folder").setDesc("Path to your Projects folder (top-level project folders live here)").addText(t=>t.setPlaceholder("Projects").setValue(this.plugin.settings.projectsPath).onChange(async e=>{let i=e.trim().replace(/\/+$/,"")||"Projects";if(i===this.plugin.settings.archivePath){new h.Notice("Projects folder cannot be the same as Archive folder");return}this.plugin.settings.projectsPath=i,await this.plugin.saveSettings()})),new h.Setting(r).setName("Archive folder").setDesc("Path where archived projects will be moved").addText(t=>t.setPlaceholder("Archive").setValue(this.plugin.settings.archivePath).onChange(async e=>{let i=e.trim().replace(/\/+$/,"")||"Archive";if(i===this.plugin.settings.projectsPath){new h.Notice("Archive folder cannot be the same as Projects folder");return}this.plugin.settings.archivePath=i,await this.plugin.saveSettings()})),new h.Setting(r).setName("Focus Projects folder after archive").setDesc("Return focus to the Projects folder in the file explorer after archiving").addToggle(t=>t.setValue(this.plugin.settings.focusAfterArchive).onChange(async e=>{this.plugin.settings.focusAfterArchive=e,await this.plugin.saveSettings()})),new h.Setting(r).setName("Confirm before archiving").setDesc("Show a confirmation dialog before archiving a project").addToggle(t=>t.setValue(this.plugin.settings.confirmBeforeArchive).onChange(async e=>{this.plugin.settings.confirmBeforeArchive=e,await this.plugin.saveSettings()}))}};function d(n){return n.replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function F(n){let r=d(n),t=r.lastIndexOf("/");return t===-1?"":r.substring(0,t)}function A(n,r){let t=d(n),e=d(r);return F(t)===e}function w(n){let r=d(n),t=r.lastIndexOf("/");return t===-1?r:r.substring(t+1)}function P(n,r,t){let e=d(n),i=`${e}/${r}`;if(!t.has(i))return i;let a=new Date().toISOString().split("T")[0],c=`${e}/${r} (Archived ${a})`;if(!t.has(c))return c;let l=2;for(;;){let p=`${e}/${r} (Archived ${a}) (${l})`;if(!t.has(p))return p;if(l++,l>1e3)throw new Error("Too many archive collisions - please clean up your archive folder")}}var j=3,m=class extends o.Modal{constructor(t,e,i,s,a){super(t);this.confirmed=!1;this.folderName=e,this.destPath=i,this.onConfirm=s,this.onCancel=a}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:"Archive Project?"}),t.createEl("p",{text:`Move "${this.folderName}" to:`}),t.createEl("p",{text:this.destPath,cls:"archive-dest-path"});let e=t.createDiv({cls:"modal-button-container"});e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let s=e.createEl("button",{text:"Archive",cls:"mod-cta"});s.addEventListener("click",()=>{this.confirmed=!0,this.onConfirm(),this.close()}),s.focus();let a=c=>{c.key==="Enter"&&!c.isComposing&&(c.preventDefault(),this.confirmed=!0,this.onConfirm(),this.close())};t.addEventListener("keydown",a)}onClose(){let{contentEl:t}=this;t.empty(),this.confirmed||this.onCancel()}},f=class extends o.Plugin{constructor(){super(...arguments);this.settings=g}async onload(){await this.loadSettings(),this.addSettingTab(new v(this.app,this)),this.registerEvent(this.app.workspace.on("file-menu",(t,e)=>{if(!(e instanceof o.TFolder)&&!(e instanceof o.TFile))return;let i=(0,o.normalizePath)(this.settings.projectsPath);A(e.path,i)&&t.addItem(s=>{s.setTitle("Archive it").setIcon("archive").onClick(async()=>{await this.archiveItem(e)})})}))}async loadSettings(){this.settings=Object.assign({},g,await this.loadData()),this.settings.projectsPath===this.settings.archivePath&&(new o.Notice("Archive Project: Invalid settings detected (paths match), resetting to defaults"),this.settings.projectsPath=g.projectsPath,this.settings.archivePath=g.archivePath,await this.saveSettings())}async saveSettings(){await this.saveData(this.settings)}async archiveItem(t){let e=(0,o.normalizePath)(this.settings.archivePath),i=w(t.path);try{await this.ensureFolderExists(e);let s=this.getExistingArchivePaths(e),a=P(e,i,s);if(this.settings.confirmBeforeArchive)return new Promise(c=>{new m(this.app,i,a,async()=>{await this.performArchive(t,a,i,e),c()},()=>c()).open()});await this.performArchive(t,a,i,e)}catch(s){let a=s instanceof Error?s.message:"Unknown error";new o.Notice(`Failed to archive "${i}": ${a}`),console.error("Archive Project: Failed to archive item",s)}}async performArchive(t,e,i,s){let a=e;for(let c=0;c<j;c++)try{await this.app.vault.rename(t,e);break}catch(l){if(c===j-1)throw l;let p=this.getExistingArchivePaths(s);p.add(e),e=P(s,i,p)}e!==a?new o.Notice(`Archived "${i}" to ${e} (path changed due to conflict)`):new o.Notice(`Archived "${i}" to ${e}`),this.settings.focusAfterArchive&&await this.focusProjectsFolder()}async ensureFolderExists(t){let e=this.app.vault.getAbstractFileByPath(t);if(!e)await this.app.vault.createFolder(t);else if(!(e instanceof o.TFolder))throw new Error(`"${t}" exists but is not a folder`)}getExistingArchivePaths(t){let e=new Set,i=this.app.vault.getAbstractFileByPath(t);if(i instanceof o.TFolder)for(let s of i.children)e.add((0,o.normalizePath)(s.path));return e}async focusProjectsFolder(){let t=(0,o.normalizePath)(this.settings.projectsPath),e=this.app.vault.getAbstractFileByPath(t);if(e)try{let i=this.app.workspace.getLeavesOfType("file-explorer")[0];if(!i)return;let s=i.view;typeof s.revealInFolder=="function"&&s.revealInFolder(e)}catch(i){console.debug("Archive Project: Could not focus Projects folder",i)}}};
